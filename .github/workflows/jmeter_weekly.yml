name: Weekly JMeter Load Test

on:
  # 手动触发
  workflow_dispatch:
  # 定时触发（GitHub 用 UTC）
  schedule:
    - cron: '0 4 * * 6'  # 覆盖 PDT (UTC-7) 的周五晚21:00 -> 周六 04:00 UTC
    - cron: '0 5 * * 6'  # 覆盖 PST (UTC-8) 的周五晚21:00 -> 周六 05:00 UTC

jobs:
  run-jmeter:
    runs-on: ubuntu-latest
    env:
      JMETER_WORKDIR: jmeter
      JMETER_PLAN: autotest1.jmx   # ← 改成你的 jmx 文件名
      TZ_LOCAL: America/Vancouver

    steps:
      - uses: actions/checkout@v4

      - name: Guard for local Friday 21:00
        run: |
          export TZ="$TZ_LOCAL"
          [ "$(date +%u)" = "5" ] && [ "$(date +%H)" = "21" ] || { echo "Not Fri 21:00 local. Skip."; exit 78; }

      - name: Run JMeter (non-GUI)
        run: |
          mkdir -p "$JMETER_WORKDIR/out"
          docker run --rm \
            -v "$GITHUB_WORKSPACE/$JMETER_WORKDIR":/tests \
            -w /tests \
            justb4/jmeter:5.6.3 \
            -n -t "$JMETER_PLAN" \
            -j out/jmeter.log \
            -l out/results.jtl \
            -e -o out/report

      - name: Fail job if there are sample errors
        run: |
          if grep -q ' s="false"' "$JMETER_WORKDIR/out/results.jtl"; then
            echo "JMeter detected failed samples."
            exit 1
          fi

      - name: Upload report artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report
          path: |
            ${{ env.JMETER_WORKDIR }}/out/report
            ${{ env.JMETER_WORKDIR }}/out/results.jtl
            ${{ env.JMETER_WORKDIR }}/out/jmeter.log
